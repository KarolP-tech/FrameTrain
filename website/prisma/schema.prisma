// Prisma Schema for FrameTrain Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  hasPaid       Boolean   @default(false) @map("has_paid")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  apiKeys       ApiKey[]
  models        Model[]
  payments      Payment[]
  
  @@map("users")
}

model ApiKey {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  key           String    @unique
  isActive      Boolean   @default(true) @map("is_active")
  expiresAt     DateTime? @map("expires_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastUsedAt    DateTime? @map("last_used_at")
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([key])
  @@index([userId])
  @@map("api_keys")
}

model Model {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  name          String
  description   String?
  status        String    @default("created") // created, training, completed, failed
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions      ModelVersion[]
  
  @@index([userId])
  @@map("models")
}

model ModelVersion {
  id            String    @id @default(cuid())
  modelId       String    @map("model_id")
  version       Int
  parameters    String    // JSON string: Training parameters (epochs, batch_size, etc.)
  metrics       String?   // JSON string: Training metrics (loss, accuracy, etc.)
  status        String    @default("pending") // pending, training, completed, failed
  createdAt     DateTime  @default(now()) @map("created_at")
  completedAt   DateTime? @map("completed_at")
  
  model         Model     @relation(fields: [modelId], references: [id], onDelete: Cascade)
  
  @@unique([modelId, version])
  @@index([modelId])
  @@map("model_versions")
}

model Payment {
  id              String    @id @default(cuid())
  userId          String?   @map("user_id")
  email           String
  amount          Int       // Amount in cents
  currency        String    @default("eur")
  stripePaymentId String?   @unique @map("stripe_payment_id")
  stripeSessionId String?   @unique @map("stripe_session_id")
  status          String    @default("pending") // pending, completed, failed, refunded
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")
  
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([email])
  @@index([userId])
  @@map("payments")
}
